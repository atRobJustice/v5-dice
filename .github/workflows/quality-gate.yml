name: Quality Gate

on:
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright
      run: npx playwright install --with-deps chromium
    
    - name: Run E2E Quality Gate Tests
      run: |
        npx playwright test tests/v5-dice-comprehensive.spec.ts \
          --project=chromium \
          --reporter=json \
          --output-dir=test-results
      
    - name: Evaluate Quality Gate
      run: |
        # Check if all critical tests passed
        PASSED_TESTS=$(cat test-results/results.json | jq '.suites[].specs[].tests[] | select(.status == "passed") | length' | wc -l)
        TOTAL_TESTS=$(cat test-results/results.json | jq '.suites[].specs[].tests | length' | wc -l)
        
        echo "Passed: $PASSED_TESTS / $TOTAL_TESTS"
        
        if [ $PASSED_TESTS -lt $TOTAL_TESTS ]; then
          echo "❌ Quality gate failed - not all tests passed"
          exit 1
        else
          echo "✅ Quality gate passed - all tests successful"
        fi
    
    - name: Update PR Status
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const state = process.env.GITHUB_JOB_STATUS === 'success' ? 'success' : 'failure';
          const description = state === 'success' 
            ? 'All E2E tests passed - ready for merge'
            : 'E2E tests failed - changes needed';
            
          github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.payload.pull_request.head.sha,
            state: state,
            target_url: `${context.payload.pull_request.html_url}/checks`,
            description: description,
            context: 'E2E Quality Gate'
          });